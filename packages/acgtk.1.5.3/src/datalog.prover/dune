;; -*-lisp-*-

(ocamllex db_lexer)
(ocamlyacc db_parser)

(ocamllex dl_lexer)
(menhir
 (flags (--explain --table --strict))
 (modules dl_parser))

;; Rule to generate the messages ml file
(rule
 (targets messages.ml)
 (enabled_if (= %{profile} dev))
 (mode promote)
 (deps
  (alias update)
  (alias check_all_messages)
  (:message_file dl_parser.messages)
  )
 (action
  (with-stdout-to messages.ml (run menhir --compile-errors %{message_file} dl_parser.mly)))
 )

;; Rule to generate the automatic message file
(rule
 (targets dl_parser.messages.automatic)
 (action
  (with-stdout-to dl_parser.messages.automatic (run menhir --list-errors dl_parser.mly)))
 )

;; Rule to generate the message file by updating previously existing
;; message file
(rule
 (targets dl_parser.messages.new)
 (action (with-stdout-to dl_parser.messages.new (run menhir --update-errors dl_parser.messages dl_parser.mly))
  )
 )

;; alias to check whether automatic new messages have been generated
;; after updating the grammar
(alias
 (name update)
 (action (diff dl_parser.messages dl_parser.messages.new))
 )

;; alias to check that all the messages in dl_parser.messages
;; containts all the error listed in dl_parser.messages.automatic
;; which is complete (generated by --list-errors)
(alias
 (name check_all_messages)
 (deps
  dl_parser.messages.automatic
  dl_parser.messages
  )
 (action (run menhir --compare-errors dl_parser.messages.automatic --compare-errors dl_parser.messages dl_parser.mly))
 )

;; This stanza declares the DatalogLib
(library
 (name datalogLib)
 (public_name acgtkLib.datalogLib)
 (flags (:standard -w -58))
 (modules (:standard db_parser db_lexer dl_lexer dl_parser \ test db_test))
 (libraries
  ;; external libraries
  str
  ANSITerminal
  menhirLib
  ;; internal library
  utilsLib
  ))

(tests
 (names test db_test)
  (modules test db_test)
  (libraries
   fmt.tty   
   utilsLib
   datalogLib
   ))


(documentation (package acgtk))
