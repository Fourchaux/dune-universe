;; -*-lisp-*-

(ocamllex data_lexer term_lexer)

(menhir
 (flags (--explain --table))
 (modules term_parser_test))

(menhir
 (merge_into data_parser)
 (flags (--explain --table --strict))
 (modules file_parser sig_parser lex_parser term_type_parser bound_term_parser))

;; Rule to generate the messages ml file
(rule
 (targets messages.ml)
 (enabled_if (= %{profile} dev))
 (mode promote)
 (deps
  (alias update)
  (alias check_all_messages)
  (:message_file data_parser.messages)
  (:parsers file_parser.mly lex_parser.mly sig_parser.mly term_type_parser.mly bound_term_parser.mly)
  )
 (action
  (with-stdout-to messages.ml (run menhir --base data_parser --compile-errors %{message_file} %{parsers})))
 )

;; Rule to generate the automatic message file
(rule
 (targets data_parser.messages.automatic)
 (deps (:parsers file_parser.mly lex_parser.mly sig_parser.mly term_type_parser.mly bound_term_parser.mly))
 (action
  (with-stdout-to data_parser.messages.automatic (run menhir --base data_parser --list-errors %{parsers})))
 )

;; Rule to generate the message file by updating previously existing
;; message file
(rule
 (targets data_parser.messages.new)
 (deps (:parsers file_parser.mly lex_parser.mly sig_parser.mly term_type_parser.mly bound_term_parser.mly))
 (action (with-stdout-to data_parser.messages.new (run menhir --base data_parser --update-errors data_parser.messages %{parsers}))
  )
 )

;; alias to check whether automatic new messages have been generated
;; after updating the grammar
(alias
 (name update)
 (action (diff data_parser.messages data_parser.messages.new))
 )

;; alias to check that all the messages in data_parser.messages
;; containts all the error listed in data_parser.messages.automatic
;; which is complete (generated by --list-errors)
(alias
 (name check_all_messages)
 (deps
  data_parser.messages.automatic
  data_parser.messages
  (:parsers file_parser.mly lex_parser.mly sig_parser.mly term_type_parser.mly bound_term_parser.mly)
  )
 (action (run menhir --base data_parser --compare-errors data_parser.messages.automatic --compare-errors data_parser.messages %{parsers}))
 )

;; This stanza declares the Grammar library
(library
 (name grammars)
  (flags (:standard -w -58))
  (modules (:standard \ acgc interactive term_test entry))
  (libraries
   menhirLib
   logic
   acgData
   )
  )

;; This declares the acgc executable implemented by acgc.ml
(executable
 (name acgc)
 (public_name acgc)
 (package acgtk)
 (modules acgc)
 (libraries
  logs
  fmt.tty
  cmdliner
  
  logic
  acgData
  grammars
  ))

(test
 (name term_test)
 (modules term_test)
 (libraries
  menhirLib
  utilsLib
  grammars)
 )



(documentation (package acgtkLib))
