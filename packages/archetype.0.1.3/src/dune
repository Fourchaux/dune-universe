(ocamllex lexer)
(menhir
  (modules parser)
  (flags --explain --inspection --table --dump))

(library
  (name archetype)
  (public_name archetype)
  (preprocess
    (pps ppx_deriving.std ppx_deriving_yojson)
  )
  (library_flags (-linkall))
  (modules tools core ident options location parseTree parser lexer symbol
  error position pureLexer parseError io printer_tools printer_pt
  printer_pt_markdown ast typing printer_ast model gen_transform gen_model
  printer_model gen_shallow_asset gen_split_key_values gen_api_storage
  gen_reduce printer_model_liq printer_model_ligo printer_model_smartpy
  printer_model_ocaml gen_why3 mlwtree printer_mlwtree printer_whyml
  )
  (libraries menhirLib uri digestif why3 ppx_deriving yojson ppx_deriving_yojson.runtime)
)

(library
  (name w3plugin)
  (modules w3plugin)
  (libraries archetype)
)

(rule
 (targets archetype_plugin.cmxs)
 (deps    archetype.cmxa w3plugin.cmxa)
 (action  (run ocamlopt -shared -linkall -o %{targets}
            %{lib:easy-format:easy_format.cmxa}
            %{lib:biniou:biniou.cmxa}
            %{lib:yojson:yojson.cmxa}
            %{lib:result:result.cmxa}
            %{lib:ppx_deriving:ppx_deriving_runtime.cmxa}
            %{lib:ppx_deriving_yojson:runtime/ppx_deriving_yojson_runtime.cmxa}
            %{deps} )))

(executable
  (preprocess
    (pps ppx_deriving.std ppx_deriving_yojson)
  )
  (modules lsp compiler)
  (libraries archetype menhirLib why3)
  (public_name archetype)
  (name     compiler))
