(jbuild_version 1)

(library
 ((name testkit)
  (modules (Testkit))
  (wrapped false)
  (libraries (dynlink uri))))

; Basic Tests

(alias ((name runtest) (deps (test_heap.exe)) (action (run ${<}))))
(executable
 ((name test_heap)
  (modules (Test_heap))
  (libraries (caqti testkit))))

(alias
 ((name runtest)
  (package caqti-lwt)
  (deps (test_pool_lwt.exe))
  (action (run ${<}))))
(executable
 ((name test_pool_lwt)
  (modules (Test_pool_lwt))
  (libraries (caqti_lwt_v1 testkit))))

; Tests Using DBs

(rule
 ((targets (uris.conf))
  (fallback)
  (action (write-file ${@} "sqlite3::memory:\n"))))

(alias
 ((name runtest)
  (package caqti-lwt)
  (deps (bikereg_v1.exe (alias drivers) uris.conf))
  (locks (/db/bikereg_v1))
  (action (setenv OCAMLPATH . (run ${<})))))
(executable
 ((name bikereg_v1)
  (modules (Bikereg_v1))
  (libraries (caqti_v1 caqti_dynload caqti_lwt_v1 testkit))))

(alias
 ((name runtest)
  (package caqti-lwt)
  (deps (bikereg.exe (alias drivers) uris.conf))
  (locks (/db/bikereg))
  (action (setenv OCAMLPATH . (run ${<})))))
(executable
 ((name bikereg)
  (modules (Bikereg))
  (libraries (caqti caqti_dynload caqti_lwt testkit))))

(alias
 ((name runtest)
  (package caqti-async)
  (deps (test_sql_async_v1.exe (alias drivers) uris.conf))
  (locks (/db/test_sql_async_v1))
  (action (setenv OCAMLPATH . (run ${<})))))
(executable
 ((name test_sql_async_v1)
  (modules (Test_sql_async_v1))
  (libraries (caqti_v1 caqti_dynload caqti_async_v1 testkit))))

(alias
 ((name runtest)
  (package caqti-async)
  (deps (test_sql_async.exe (alias drivers) uris.conf))
  (locks (/db/test_sql_async))
  (action (setenv OCAMLPATH . (run ${<})))))
(executable
 ((name test_sql_async)
  (modules (Test_sql_async))
  (libraries (caqti caqti_dynload caqti_async testkit))))

(alias
 ((name runtest)
  (package caqti-lwt)
  (deps (test_parallel_lwt_v1.exe (alias drivers) uris.conf))
  (locks (/db/test_parallel_lwt_v1))
  (action (setenv OCAMLPATH . (run ${<})))))
(executable
 ((name test_parallel_lwt_v1)
  (modules (Test_parallel_lwt_v1))
  (libraries (caqti_v1 caqti_dynload caqti_lwt_v1 testkit))))

(alias
 ((name runtest)
  (package caqti-lwt)
  (deps (test_parallel_lwt.exe (alias drivers) uris.conf))
  (locks (/db/test_parallel_lwt))
  (action (setenv OCAMLPATH . (run ${<})))))
(executable
 ((name test_parallel_lwt)
  (modules (Test_parallel_lwt))
  (libraries (caqti caqti_dynload caqti_lwt testkit))))

(alias
 ((name runtest)
  (package caqti-lwt)
  (deps (test_sql_lwt_v1.exe (alias drivers) uris.conf))
  (locks (/db/test_sql_lwt_v1))
  (action (setenv OCAMLPATH . (run ${<})))))
(executable
 ((name test_sql_lwt_v1)
  (modules (Test_sql_lwt_v1))
  (libraries (caqti_v1 caqti_dynload caqti_lwt_v1 testkit))))

(alias
 ((name runtest)
  (package caqti-lwt)
  (deps (test_sql_lwt.exe (alias drivers) uris.conf))
  (locks (/db/test_sql_lwt))
  (action (setenv OCAMLPATH . (run ${<})))))
(executable
 ((name test_sql_lwt)
  (modules (Test_sql_lwt))
  (libraries (caqti caqti_dynload caqti_lwt ptime.clock.os testkit))))

(alias
 ((name runtest)
  (package caqti-lwt)
  (deps (test_param.exe (alias drivers) uris.conf))
  (action (setenv OCAMLPATH . (run ${<})))))
(executable
 ((name test_param)
  (modules (Test_param))
  (libraries (caqti caqti_dynload caqti_lwt testkit))))

; Fake META Files

(alias
 ((name drivers)
  (deps (META.caqti
         ../lib/caqti.cma
         ../lib/caqti.cmxs
         ../lib/caqti_v1.cma
         ../lib/caqti_v1.cmxs))))
(rule
 ((targets (META.caqti))
  (deps (../META.caqti))
  (action
   (with-stdout-to ${@}
    (progn
      (echo "directory = \"../lib\"\n")
      (run sed "/^ *directory *= *\"v1\"/d" ${<}))))))

(alias
 ((name drivers)
  (package caqti-driver-mariadb)
  (deps (META.caqti-driver-mariadb
         ../lib-driver/caqti_driver_mariadb.cma
         ../lib-driver/caqti_driver_mariadb.cmxs
         ../lib-driver/caqti_driver_mariadb_v1.cma
         ../lib-driver/caqti_driver_mariadb_v1.cmxs))))
(rule
 ((targets (META.caqti-driver-mariadb))
  (deps (../META.caqti-driver-mariadb))
  (action
   (with-stdout-to ${@}
    (progn
      (echo "directory = \"../lib-driver\"\n")
      (run sed "/^ *directory *= *\"v1\"/d" ${<}))))))

(alias
 ((name drivers)
  (package caqti-driver-sqlite3)
  (deps (META.caqti-driver-sqlite3
         ../lib-driver/caqti_driver_sqlite3.cma
         ../lib-driver/caqti_driver_sqlite3.cmxs
         ../lib-driver/caqti_driver_sqlite3_v1.cma
         ../lib-driver/caqti_driver_sqlite3_v1.cmxs))))
(rule
 ((targets (META.caqti-driver-sqlite3))
  (deps (../META.caqti-driver-sqlite3))
  (action
   (with-stdout-to ${@}
    (progn
      (echo "directory = \"../lib-driver\"\n")
      (run sed "/^ *directory *= *\"v1\"/d" ${<}))))))

(alias
 ((name drivers)
  (package caqti-driver-postgresql)
  (deps (META.caqti-driver-postgresql
         ../lib-driver/caqti_driver_postgresql.cma
         ../lib-driver/caqti_driver_postgresql.cmxs
         ../lib-driver/caqti_driver_postgresql_v1.cma
         ../lib-driver/caqti_driver_postgresql_v1.cmxs))))
(rule
 ((targets (META.caqti-driver-postgresql))
  (deps (../META.caqti-driver-postgresql))
  (action
   (with-stdout-to ${@}
    (progn
      (echo "directory = \"../lib-driver\"\n")
      (run sed "/^ *directory *= *\"v1\"/d" ${<}))))))
